'use strict';

describe('Service: articles', function () {

  // load the service's module
  beforeEach(module('ngswipeDemoApp'));

  // instantiate service
  var articles
    , $httpBackend
    , scope
    , atomArticle = {
      "title": "LevelDB and Node: Getting Up and Running",
      "link": {
        "href": "http:\/\/dailyjs.com\/2013\/05\/03\/leveldb-and-node-2"
      },
      "updated": "2013-05-03T00:00:00+01:00",
      "id": "http:\/\/dailyjs.com\/2013\/05\/03\/leveldb-and-node-2",
      "content": {
        "type": "html",
        "content": "\n     <p>This is the second article in a three-part series on LevelDB and how it can be used in Node.<\/p>\n<ul class='parts'>\n  <li><a href='http:\/\/dailyjs.com\/2013\/04\/19\/leveldb-and-node-1\/'>Part 1: What is LevelDB Anyway?<\/a><\/li>\n  <li><a href='http:\/\/dailyjs.com\/2013\/05\/03\/leveldb-and-node-2\/'><strong>Part 2: Getting Up and Running<\/strong><\/a><\/li>\n<\/ul>\n<p>Our first article covered the basics of LevelDB and its internals. If you haven&#8217;t already read it you are encouraged to do so as we will be building upon this knowledge as we introduce the Node interface in this article.<\/p>\n\n<p><img src='http:\/\/dailyjs.com\/images\/posts\/leveldb.png' alt='LevelDB' \/><\/p>\n\n<p>There are two primary libraries for using LevelDB in Node, <strong><a href='https:\/\/github.com\/rvagg\/node-leveldown'>LevelDOWN<\/a><\/strong> and <strong><a href='https:\/\/github.com\/rvagg\/node-levelup'>LevelUP<\/a><\/strong>.<\/p>\n\n<p><strong>LevelDOWN<\/strong> is a pure C++ interface between Node.js and LevelDB. Its API provides limited <em>sugar<\/em> and is mostly a straight-forward mapping of LevelDB&#8217;s operations into JavaScript. All I\/O operations in LevelDOWN are asynchronous and take advantage of LevelDB&#8217;s thread-safe nature to parallelise reads and writes.<\/p>\n\n<p><strong>LevelUP<\/strong> is the library that the majority of people will use to interface with LevelDB in Node. It wraps LevelDOWN to provide a more Node.js-style interface. Its API provides more <em>sugar<\/em> than LevelDOWN, with features such as optional arguments and deferred-till-open operations (i.e. if you begin operating on a database that is in the process of being opened, the operations will be queued until the open is complete).<\/p>\n\n<p>LevelUP exposes iterators as Node.js-style object streams. A LevelUP <strong>ReadStream<\/strong> can be used to read sequential entries, forward or reverse, to and from any key.<\/p>\n\n<p>LevelUP handles JSON and other encoding types for you. For example, when operating on a LevelUP instance with JSON value-encoding, you simply pass in your objects for writes and they are serialised for you. Likewise, when you read them, they are deserialised and passed back in their original form.<\/p>\n\n<h3 id='a_simple_levelup_example'>A simple LevelUP example<\/h3>\n<div class='highlight'><pre><code class='javascript'><span class='kd'>var<\/span> <span class='nx'>levelup<\/span> <span class='o'>=<\/span> <span class='nx'>require<\/span><span class='p'>(<\/span><span class='s1'>&#39;levelup&#39;<\/span><span class='p'>)<\/span>\n\n<span class='c1'>\/\/ open a data store<\/span>\n<span class='kd'>var<\/span> <span class='nx'>db<\/span> <span class='o'>=<\/span> <span class='nx'>levelup<\/span><span class='p'>(<\/span><span class='s1'>&#39;\/tmp\/dprk.db&#39;<\/span><span class='p'>)<\/span>\n\n<span class='c1'>\/\/ a simple Put operation<\/span>\n<span class='nx'>db<\/span><span class='p'>.<\/span><span class='nx'>put<\/span><span class='p'>(<\/span><span class='s1'>&#39;name&#39;<\/span><span class='p'>,<\/span> <span class='s1'>&#39;Kim Jong-un&#39;<\/span><span class='p'>,<\/span> <span class='kd'>function<\/span> <span class='p'>(<\/span><span class='nx'>err<\/span><span class='p'>)<\/span> <span class='p'>{<\/span>\n\n  <span class='c1'>\/\/ a Batch operation made up of 3 Puts<\/span>\n  <span class='nx'>db<\/span><span class='p'>.<\/span><span class='nx'>batch<\/span><span class='p'>([<\/span>\n      <span class='p'>{<\/span> <span class='nx'>type<\/span><span class='o'>:<\/span> <span class='s1'>&#39;put&#39;<\/span><span class='p'>,<\/span> <span class='nx'>key<\/span><span class='o'>:<\/span> <span class='s1'>&#39;spouse&#39;<\/span><span class='p'>,<\/span> <span class='nx'>value<\/span><span class='o'>:<\/span> <span class='s1'>&#39;Ri Sol-ju&#39;<\/span> <span class='p'>}<\/span>\n    <span class='p'>,<\/span> <span class='p'>{<\/span> <span class='nx'>type<\/span><span class='o'>:<\/span> <span class='s1'>&#39;put&#39;<\/span><span class='p'>,<\/span> <span class='nx'>key<\/span><span class='o'>:<\/span> <span class='s1'>&#39;dob&#39;<\/span><span class='p'>,<\/span> <span class='nx'>value<\/span><span class='o'>:<\/span> <span class='s1'>&#39;8 January 1983&#39;<\/span> <span class='p'>}<\/span>\n    <span class='p'>,<\/span> <span class='p'>{<\/span> <span class='nx'>type<\/span><span class='o'>:<\/span> <span class='s1'>&#39;put&#39;<\/span><span class='p'>,<\/span> <span class='nx'>key<\/span><span class='o'>:<\/span> <span class='s1'>&#39;occupation&#39;<\/span><span class='p'>,<\/span> <span class='nx'>value<\/span><span class='o'>:<\/span> <span class='s1'>&#39;Clown&#39;<\/span> <span class='p'>}<\/span>\n  <span class='p'>],<\/span> <span class='kd'>function<\/span> <span class='p'>(<\/span><span class='nx'>err<\/span><span class='p'>)<\/span> <span class='p'>{<\/span>\n\n    <span class='c1'>\/\/ read the whole store as a stream and print each entry to stdout<\/span>\n    <span class='nx'>db<\/span><span class='p'>.<\/span><span class='nx'>createReadStream<\/span><span class='p'>()<\/span>\n      <span class='p'>.<\/span><span class='nx'>on<\/span><span class='p'>(<\/span><span class='s1'>&#39;data&#39;<\/span><span class='p'>,<\/span> <span class='nx'>console<\/span><span class='p'>.<\/span><span class='nx'>log<\/span><span class='p'>)<\/span>\n      <span class='p'>.<\/span><span class='nx'>on<\/span><span class='p'>(<\/span><span class='s1'>&#39;close&#39;<\/span><span class='p'>,<\/span> <span class='kd'>function<\/span> <span class='p'>()<\/span> <span class='p'>{<\/span>\n        <span class='nx'>db<\/span><span class='p'>.<\/span><span class='nx'>close<\/span><span class='p'>()<\/span>\n      <span class='p'>})<\/span>\n  <span class='p'>})<\/span>\n<span class='p'>})<\/span>\n<\/code><\/pre>\n<\/div>\n<p>Execute this application and you&#8217;ll end up with this output:<\/p>\n<div class='highlight'><pre><code class='javascript'><span class='p'>{<\/span> <span class='nx'>key<\/span><span class='o'>:<\/span> <span class='s1'>&#39;dob&#39;<\/span><span class='p'>,<\/span> <span class='nx'>value<\/span><span class='o'>:<\/span> <span class='s1'>&#39;8 January 1983&#39;<\/span> <span class='p'>}<\/span>\n<span class='p'>{<\/span> <span class='nx'>key<\/span><span class='o'>:<\/span> <span class='s1'>&#39;name&#39;<\/span><span class='p'>,<\/span> <span class='nx'>value<\/span><span class='o'>:<\/span> <span class='s1'>&#39;Kim Jong-un&#39;<\/span> <span class='p'>}<\/span>\n<span class='p'>{<\/span> <span class='nx'>key<\/span><span class='o'>:<\/span> <span class='s1'>&#39;occupation&#39;<\/span><span class='p'>,<\/span> <span class='nx'>value<\/span><span class='o'>:<\/span> <span class='s1'>&#39;Clown&#39;<\/span> <span class='p'>}<\/span>\n<span class='p'>{<\/span> <span class='nx'>key<\/span><span class='o'>:<\/span> <span class='s1'>&#39;spouse&#39;<\/span><span class='p'>,<\/span> <span class='nx'>value<\/span><span class='o'>:<\/span> <span class='s1'>&#39;Ri Sol-ju&#39;<\/span> <span class='p'>}<\/span>\n<\/code><\/pre>\n<\/div>\n<h3 id='basic_operations'>Basic operations<\/h3>\n\n<h4 id='open'>Open<\/h4>\n\n<p>There are two ways to create a new LevelDB store, or open an existing one:<\/p>\n<div class='highlight'><pre><code class='javascript'><span class='nx'>levelup<\/span><span class='p'>(<\/span><span class='s1'>&#39;\/path\/to\/database&#39;<\/span><span class='p'>,<\/span> <span class='kd'>function<\/span> <span class='p'>(<\/span><span class='nx'>err<\/span><span class='p'>,<\/span> <span class='nx'>db<\/span><span class='p'>)<\/span> <span class='p'>{<\/span>\n  <span class='cm'>\/* use `db` *\/<\/span>\n<span class='p'>})<\/span>\n\n<span class='c1'>\/\/ or<\/span>\n\n<span class='kd'>var<\/span> <span class='nx'>db<\/span> <span class='o'>=<\/span> <span class='nx'>levelup<\/span><span class='p'>(<\/span><span class='s1'>&#39;\/path\/to\/database&#39;<\/span><span class='p'>)<\/span>\n<span class='cm'>\/* use `db` *\/<\/span>\n<\/code><\/pre>\n<\/div>\n<p>The first version is a more standard Node-style async instantiation. You only start using the <code>db<\/code> when LevelDB is set up and ready.<\/p>\n\n<p>The second version is a little more opaque. It looks like a synchronous operation but the actual <em>open<\/em> call is still asynchronous although you get a <code>LevelUP<\/code> object back immediately to use. Any calls you make on that object that need to operate on the underlying LevelDB store are <em>queued<\/em> until the store is ready to accept calls. The actual open operation is very quick so the initial is delay generally not noticeable.<\/p>\n\n<h4 id='close'>Close<\/h4>\n\n<p>To close a LevelDB store, simply call <code>close()<\/code> and your callback will be called when the underlying store is completely closed:<\/p>\n<div class='highlight'><pre><code class='javascript'><span class='c1'>\/\/ close to clean up<\/span>\n<span class='nx'>db<\/span><span class='p'>.<\/span><span class='nx'>close<\/span><span class='p'>(<\/span><span class='kd'>function<\/span> <span class='p'>(<\/span><span class='nx'>err<\/span><span class='p'>)<\/span> <span class='p'>{<\/span> <span class='cm'>\/* ... *\/<\/span> <span class='p'>})<\/span>\n<\/code><\/pre>\n<\/div>\n<h4 id='read_write_and_delete'>Read, write and delete<\/h4>\n\n<p>Reading and writing are what you would expect for asynchronous Node methods:<\/p>\n<div class='highlight'><pre><code class='javascript'><span class='nx'>db<\/span><span class='p'>.<\/span><span class='nx'>put<\/span><span class='p'>(<\/span><span class='s1'>&#39;key&#39;<\/span><span class='p'>,<\/span> <span class='s1'>&#39;value&#39;<\/span><span class='p'>,<\/span> <span class='kd'>function<\/span> <span class='p'>(<\/span><span class='nx'>err<\/span><span class='p'>)<\/span> <span class='p'>{<\/span> <span class='cm'>\/* ... *\/<\/span> <span class='p'>})<\/span>\n\n<span class='nx'>db<\/span><span class='p'>.<\/span><span class='nx'>del<\/span><span class='p'>(<\/span><span class='s1'>&#39;key&#39;<\/span><span class='p'>,<\/span> <span class='kd'>function<\/span> <span class='p'>(<\/span><span class='nx'>err<\/span><span class='p'>)<\/span> <span class='p'>{<\/span> <span class='cm'>\/* ... *\/<\/span> <span class='p'>})<\/span>\n\n<span class='nx'>db<\/span><span class='p'>.<\/span><span class='nx'>get<\/span><span class='p'>(<\/span><span class='s1'>&#39;key&#39;<\/span><span class='p'>,<\/span> <span class='kd'>function<\/span> <span class='p'>(<\/span><span class='nx'>err<\/span><span class='p'>,<\/span> <span class='nx'>value<\/span><span class='p'>)<\/span> <span class='p'>{<\/span> <span class='cm'>\/* ... *\/<\/span> <span class='p'>})<\/span>\n<\/code><\/pre>\n<\/div>\n<h4 id='batch'>Batch<\/h4>\n\n<p>As mentioned in the <a href='http:\/\/dailyjs.com\/2013\/04\/19\/leveldb-and-node-1\/'>first article<\/a>, LevelDB has a <em>batch<\/em> operation that performs atomic writes. These writes can be either <em>put<\/em> or <em>delete<\/em> operations.<\/p>\n\n<p>LevelUP takes an array to perform a batch, each element of the array is either a <code>&#39;put&#39;<\/code> or a <code>&#39;del&#39;<\/code>:<\/p>\n<div class='highlight'><pre><code class='javascript'><span class='kd'>var<\/span> <span class='nx'>operations<\/span> <span class='o'>=<\/span> <span class='p'>[<\/span>\n    <span class='p'>{<\/span> <span class='nx'>type<\/span><span class='o'>:<\/span> <span class='s1'>&#39;put&#39;<\/span><span class='p'>,<\/span> <span class='nx'>key<\/span><span class='o'>:<\/span> <span class='s1'>&#39;Franciscus&#39;<\/span><span class='p'>,<\/span> <span class='nx'>value<\/span><span class='o'>:<\/span> <span class='s1'>&#39;Jorge Mario Bergoglio&#39;<\/span> <span class='p'>}<\/span>\n  <span class='p'>,<\/span> <span class='p'>{<\/span> <span class='nx'>type<\/span><span class='o'>:<\/span> <span class='s1'>&#39;del&#39;<\/span><span class='p'>,<\/span> <span class='nx'>key<\/span><span class='o'>:<\/span> <span class='s1'>&#39;Benedictus XVI&#39;<\/span> <span class='p'>}<\/span>\n<span class='p'>]<\/span>\n\n<span class='nx'>db<\/span><span class='p'>.<\/span><span class='nx'>batch<\/span><span class='p'>(<\/span><span class='nx'>operations<\/span><span class='p'>,<\/span> <span class='kd'>function<\/span> <span class='p'>(<\/span><span class='nx'>err<\/span><span class='p'>)<\/span> <span class='p'>{<\/span> <span class='cm'>\/* ... *\/<\/span> <span class='p'>})<\/span>\n<\/code><\/pre>\n<\/div>\n<h3 id='streams'>Streams!<\/h3>\n\n<p>LevelUP turns LevelDB&#8217;s <strong>Iterators<\/strong> into Node&#8217;s readable streams, making them surprisingly powerful as a query mechanism.<\/p>\n\n<p>LevelUP&#8217;s ReadStreams share all the same characteristics as standard Node readable object streams, such as being able to <code>pipe()<\/code> to other streams. They also emit all of the the expected events.<\/p>\n<div class='highlight'><pre><code class='javascript'><span class='kd'>var<\/span> <span class='nx'>rs<\/span> <span class='o'>=<\/span> <span class='nx'>db<\/span><span class='p'>.<\/span><span class='nx'>createReadStream<\/span><span class='p'>()<\/span>\n\n<span class='c1'>\/\/ our new stream will emit a &#39;data&#39; event for every entry in the store<\/span>\n\n<span class='nx'>rs<\/span><span class='p'>.<\/span><span class='nx'>on<\/span><span class='p'>(<\/span><span class='s1'>&#39;data&#39;<\/span> <span class='p'>,<\/span> <span class='kd'>function<\/span> <span class='p'>(<\/span><span class='nx'>data<\/span><span class='p'>)<\/span> <span class='p'>{<\/span> <span class='cm'>\/* data.key &amp; data.value *\/<\/span> <span class='p'>})<\/span>\n<span class='nx'>rs<\/span><span class='p'>.<\/span><span class='nx'>on<\/span><span class='p'>(<\/span><span class='s1'>&#39;error&#39;<\/span><span class='p'>,<\/span> <span class='kd'>function<\/span> <span class='p'>(<\/span><span class='nx'>err<\/span><span class='p'>)<\/span> <span class='p'>{<\/span> <span class='cm'>\/* handle err *\/<\/span> <span class='p'>})<\/span>\n<span class='nx'>rs<\/span><span class='p'>.<\/span><span class='nx'>on<\/span><span class='p'>(<\/span><span class='s1'>&#39;close&#39;<\/span><span class='p'>,<\/span> <span class='kd'>function<\/span> <span class='p'>()<\/span> <span class='p'>{<\/span> <span class='cm'>\/* stream finished &amp; cleaned up *\/<\/span> <span class='p'>})<\/span>\n<\/code><\/pre>\n<\/div>\n<p>But it&#8217;s the various options for <code>createReadStream()<\/code>, combined with the fact that LevelDB sorts by keys that makes it a powerful abstraction:<\/p>\n<div class='highlight'><pre><code class='javascript'><span class='nx'>db<\/span><span class='p'>.<\/span><span class='nx'>createReadStream<\/span><span class='p'>({<\/span>\n    <span class='nx'>start<\/span>     <span class='o'>:<\/span> <span class='s1'>&#39;somewheretostart&#39;<\/span>\n  <span class='p'>,<\/span> <span class='nx'>end<\/span>       <span class='o'>:<\/span> <span class='s1'>&#39;endkey&#39;<\/span>\n  <span class='p'>,<\/span> <span class='nx'>limit<\/span>     <span class='o'>:<\/span> <span class='mi'>100<\/span>           <span class='c1'>\/\/ maximum number of entries to read<\/span>\n  <span class='p'>,<\/span> <span class='nx'>reverse<\/span>   <span class='o'>:<\/span> <span class='kc'>true<\/span>          <span class='c1'>\/\/ flip direction<\/span>\n  <span class='p'>,<\/span> <span class='nx'>keys<\/span>      <span class='o'>:<\/span> <span class='kc'>true<\/span>          <span class='c1'>\/\/ see db.createKeyStream()<\/span>\n  <span class='p'>,<\/span> <span class='nx'>values<\/span>    <span class='o'>:<\/span> <span class='kc'>true<\/span>          <span class='c1'>\/\/ see db.createValueStream()<\/span>\n<span class='p'>})<\/span>\n<\/code><\/pre>\n<\/div>\n<p><code>&#39;start&#39;<\/code> and <code>&#39;end&#39;<\/code> point to keys in the store. These don&#8217;t need to even exist as actual keys because LevelDB will simply jump to the <em>next existing key<\/em> in lexicographical order. We&#8217;ll see later why this is helpful when we explore <em>namespacing<\/em> and <em>range queries<\/em>.<\/p>\n\n<p>LevelUP also provides a <strong>WriteStream<\/strong> which maps <code>write()<\/code> operations to Puts or Batches.<\/p>\n\n<p>Since ReadStream and WriteStream follow standard Node.js stream patterns, a <em>copy database<\/em> operation is simply a <code>pipe()<\/code> call:<\/p>\n<div class='highlight'><pre><code class='javascript'><span class='kd'>function<\/span> <span class='nx'>copy<\/span> <span class='p'>(<\/span><span class='nx'>srcdb<\/span><span class='p'>,<\/span> <span class='nx'>destdb<\/span><span class='p'>,<\/span> <span class='nx'>callback<\/span><span class='p'>)<\/span> <span class='p'>{<\/span>\n  <span class='nx'>srcdb<\/span><span class='p'>.<\/span><span class='nx'>createReadStream<\/span><span class='p'>()<\/span>\n    <span class='p'>.<\/span><span class='nx'>pipe<\/span><span class='p'>(<\/span><span class='nx'>destdb<\/span><span class='p'>.<\/span><span class='nx'>createWriteStream<\/span><span class='p'>())<\/span>\n    <span class='p'>.<\/span><span class='nx'>on<\/span><span class='p'>(<\/span><span class='s1'>&#39;error&#39;<\/span><span class='p'>,<\/span> <span class='nx'>callback<\/span><span class='p'>)<\/span>\n    <span class='p'>.<\/span><span class='nx'>on<\/span><span class='p'>(<\/span><span class='s1'>&#39;close&#39;<\/span><span class='p'>,<\/span> <span class='nx'>callback<\/span><span class='p'>)<\/span>\n<span class='p'>}<\/span>\n<\/code><\/pre>\n<\/div>\n<h3 id='encoding'>Encoding<\/h3>\n\n<p>LevelUP will accept most kinds of JavaScript objects, including Node&#8217;s <code>Buffer<\/code>s, as both keys and values for all its operations. LevelDB stores everything as simple byte arrays so most objects need to be <em>encoded<\/em> and <em>decoded<\/em> as they go in and come out of the store.<\/p>\n\n<p>You can specify the encoding of a LevelUP instance and you can also specify the encoding of individual operations. This means that you can easily store text and binary data in the same store.<\/p>\n\n<p><code>&#39;utf8&#39;<\/code> is the default encoding but you can change that to any of the standard Node <code>Buffer<\/code> encodings. You can also use the special <code>&#39;json&#39;<\/code> encoding:<\/p>\n<div class='highlight'><pre><code class='javascript'><span class='kd'>var<\/span> <span class='nx'>db<\/span> <span class='o'>=<\/span> <span class='nx'>levelup<\/span><span class='p'>(<\/span><span class='s1'>&#39;\/tmp\/dprk.db&#39;<\/span><span class='p'>,<\/span> <span class='p'>{<\/span> <span class='nx'>valueEncoding<\/span><span class='o'>:<\/span> <span class='s1'>&#39;json&#39;<\/span> <span class='p'>})<\/span>\n\n<span class='nx'>db<\/span><span class='p'>.<\/span><span class='nx'>put<\/span><span class='p'>(<\/span>\n    <span class='s1'>&#39;dprk&#39;<\/span>\n  <span class='p'>,<\/span> <span class='p'>{<\/span>\n        <span class='nx'>name<\/span>       <span class='o'>:<\/span> <span class='s1'>&#39;Kim Jong-un&#39;<\/span>\n      <span class='p'>,<\/span> <span class='nx'>spouse<\/span>     <span class='o'>:<\/span> <span class='s1'>&#39;Ri Sol-ju&#39;<\/span>\n      <span class='p'>,<\/span> <span class='nx'>dob<\/span>        <span class='o'>:<\/span> <span class='s1'>&#39;8 January 1983&#39;<\/span>\n      <span class='p'>,<\/span> <span class='nx'>occupation<\/span> <span class='o'>:<\/span> <span class='s1'>&#39;Clown&#39;<\/span>\n    <span class='p'>}<\/span>\n  <span class='p'>,<\/span> <span class='kd'>function<\/span> <span class='p'>(<\/span><span class='nx'>err<\/span><span class='p'>)<\/span> <span class='p'>{<\/span>\n      <span class='nx'>db<\/span><span class='p'>.<\/span><span class='nx'>get<\/span><span class='p'>(<\/span><span class='s1'>&#39;dprk&#39;<\/span><span class='p'>,<\/span> <span class='kd'>function<\/span> <span class='p'>(<\/span><span class='nx'>err<\/span><span class='p'>,<\/span> <span class='nx'>value<\/span><span class='p'>)<\/span> <span class='p'>{<\/span>\n        <span class='nx'>console<\/span><span class='p'>.<\/span><span class='nx'>log<\/span><span class='p'>(<\/span><span class='s1'>&#39;dprk:&#39;<\/span><span class='p'>,<\/span> <span class='nx'>value<\/span><span class='p'>)<\/span>\n        <span class='nx'>db<\/span><span class='p'>.<\/span><span class='nx'>close<\/span><span class='p'>()<\/span>\n      <span class='p'>})<\/span>\n    <span class='p'>}<\/span>\n<span class='p'>)<\/span>\n<\/code><\/pre>\n<\/div>\n<p>Gives you the following output:<\/p>\n<div class='highlight'><pre><code class='javascript'><span class='nx'>dprk<\/span><span class='o'>:<\/span> <span class='p'>{<\/span> <span class='nx'>name<\/span><span class='o'>:<\/span> <span class='s1'>&#39;Kim Jong-un&#39;<\/span><span class='p'>,<\/span>\n  <span class='nx'>spouse<\/span><span class='o'>:<\/span> <span class='s1'>&#39;Ri Sol-ju&#39;<\/span><span class='p'>,<\/span>\n  <span class='nx'>dob<\/span><span class='o'>:<\/span> <span class='s1'>&#39;8 January 1983&#39;<\/span><span class='p'>,<\/span>\n  <span class='nx'>occupation<\/span><span class='o'>:<\/span> <span class='s1'>&#39;Clown&#39;<\/span> <span class='p'>}<\/span>\n<\/code><\/pre>\n<\/div>\n<h3 id='advanced_example'>Advanced example<\/h3>\n\n<p>In this example we assume the data store contains numeric data, where ranges of data are stored with <em>prefixes<\/em> on the keys. Our example function takes a LevelUP instance and a range key prefix and uses a ReadStream to calculate the variance of the values in that range using an <a href='http:\/\/en.wikipedia.org\/wiki\/Algorithms_for_calculating_variance#Online_algorithm'>online algorithm<\/a>:<\/p>\n<div class='highlight'><pre><code class='javascript'><span class='kd'>function<\/span> <span class='nx'>variance<\/span> <span class='p'>(<\/span><span class='nx'>db<\/span><span class='p'>,<\/span> <span class='nx'>prefix<\/span><span class='p'>,<\/span> <span class='nx'>callback<\/span><span class='p'>)<\/span> <span class='p'>{<\/span>\n  <span class='kd'>var<\/span> <span class='nx'>n<\/span> <span class='o'>=<\/span> <span class='mi'>0<\/span><span class='p'>,<\/span> <span class='nx'>m2<\/span> <span class='o'>=<\/span> <span class='mi'>0<\/span><span class='p'>,<\/span> <span class='nx'>mean<\/span> <span class='o'>=<\/span> <span class='mi'>0<\/span>\n\n  <span class='nx'>db<\/span><span class='p'>.<\/span><span class='nx'>createReadStream<\/span><span class='p'>({<\/span>\n        <span class='nx'>start<\/span> <span class='o'>:<\/span> <span class='nx'>prefix<\/span>          <span class='c1'>\/\/ jump to first key with the prefix<\/span>\n      <span class='p'>,<\/span> <span class='nx'>end<\/span>   <span class='o'>:<\/span> <span class='nx'>prefix<\/span> <span class='o'>+<\/span> <span class='s1'>&#39;\\xFF&#39;<\/span> <span class='c1'>\/\/ stop at the last key with the prefix<\/span>\n    <span class='p'>})<\/span>\n    <span class='p'>.<\/span><span class='nx'>on<\/span><span class='p'>(<\/span><span class='s1'>&#39;data&#39;<\/span><span class='p'>,<\/span> <span class='kd'>function<\/span> <span class='p'>(<\/span><span class='nx'>data<\/span><span class='p'>)<\/span> <span class='p'>{<\/span>\n      <span class='kd'>var<\/span> <span class='nx'>delta<\/span> <span class='o'>=<\/span> <span class='nx'>data<\/span><span class='p'>.<\/span><span class='nx'>value<\/span> <span class='o'>-<\/span> <span class='nx'>mean<\/span>\n      <span class='nx'>mean<\/span> <span class='o'>+=<\/span> <span class='nx'>delta<\/span> <span class='o'>\/<\/span> <span class='o'>++<\/span><span class='nx'>n<\/span>\n      <span class='nx'>m2<\/span> <span class='o'>=<\/span> <span class='nx'>m2<\/span> <span class='o'>+<\/span> <span class='nx'>delta<\/span> <span class='o'>*<\/span> <span class='p'>(<\/span><span class='nx'>data<\/span><span class='p'>.<\/span><span class='nx'>value<\/span> <span class='o'>-<\/span> <span class='nx'>mean<\/span><span class='p'>)<\/span>\n    <span class='p'>})<\/span>\n    <span class='p'>.<\/span><span class='nx'>on<\/span><span class='p'>(<\/span><span class='s1'>&#39;error&#39;<\/span><span class='p'>,<\/span> <span class='nx'>callback<\/span><span class='p'>)<\/span>\n    <span class='p'>.<\/span><span class='nx'>on<\/span><span class='p'>(<\/span><span class='s1'>&#39;close&#39;<\/span><span class='p'>,<\/span> <span class='kd'>function<\/span> <span class='p'>()<\/span> <span class='p'>{<\/span>\n      <span class='nx'>callback<\/span><span class='p'>(<\/span><span class='kc'>null<\/span><span class='p'>,<\/span> <span class='nx'>m2<\/span> <span class='o'>\/<\/span> <span class='p'>(<\/span><span class='nx'>n<\/span> <span class='o'>-<\/span> <span class='mi'>1<\/span><span class='p'>))<\/span>\n    <span class='p'>})<\/span>\n<span class='p'>}<\/span>\n<\/code><\/pre>\n<\/div>\n<p>Let&#8217;s say you were collecting temperature data and you stored your keys in the form: <code>location~timestamp<\/code>. Sampling approximately every 5 seconds, collecting temperatures in Celsius we may have data that looks like this:<\/p>\n<div class='highlight'><pre><code class='text'>au_nsw_southcoast~1367487282112 = 18.23\nau_nsw_southcoast~1367487287114 = 18.22\nau_nsw_southcoast~1367487292118 = 18.23\nau_nsw_southcoast~1367487297120 = 18.23\nau_nsw_southcoast~1367487302124 = 18.24\nau_nsw_southcoast~1367487307127 = 18.24\n...\n<\/code><\/pre>\n<\/div>\n<p>To calculate the variance we can use our function to do it while efficiently streaming values from our store by simply calling:<\/p>\n<div class='highlight'><pre><code class='javascript'><span class='nx'>variance<\/span><span class='p'>(<\/span><span class='nx'>db<\/span><span class='p'>,<\/span> <span class='s1'>&#39;au_nsw_southcoast~&#39;<\/span><span class='p'>,<\/span> <span class='kd'>function<\/span> <span class='p'>(<\/span><span class='nx'>err<\/span><span class='p'>,<\/span> <span class='nx'>v<\/span><span class='p'>)<\/span> <span class='p'>{<\/span>\n  <span class='cm'>\/* v = variance *\/<\/span>\n<span class='p'>})<\/span>\n<\/code><\/pre>\n<\/div>\n<h3 id='namespacing'>Namespacing<\/h3>\n\n<p>The concept of namespacing keys will probably be familiar if you&#8217;re used to using a key\/value store of some kind. By separating keys by prefixes we create discrete <em>buckets<\/em>, much like a <em>table<\/em> in a traditional relational database is used to separate different kinds of data.<\/p>\n\n<p>It may be tempting to create separate LevelDB stores for different buckets of data but you can take better advantage of LevelDB&#8217;s caching mechanisms if you can keep the data organised in a single store.<\/p>\n\n<p>Because LevelDB is sorted, choosing a namespace separator character can have an impact on the order of your entries. A commonly chosen namespace character often used in NoSQL databases is <code>&#39;:&#39;<\/code>. However, this character lands in the middle of the list of <em>printable ASCII characters<\/em> (character code 58), so your entries may not end up being sorted in a useful order.<\/p>\n\n<p>Imagine you&#8217;re implementing a web server session store with LevelDB and you&#8217;re prefixing keys with usernames. You may have entries that look like this:<\/p>\n<div class='highlight'><pre><code class='text'>rod.vagg:last_login    = 1367487479499\nrod.vagg:default_theme = psychedelic \nrod1977:last_login     = 1367434022300\nrod1977:default_theme  = disco\nrod:last_login         = 1367488445080\nrod:default_theme      = funky\nroderick:last_login    = 1367400900133\nroderick:default_theme = whoa\n<\/code><\/pre>\n<\/div>\n<p>Note that these entries are sorted and that <code>&#39;.&#39;<\/code> (character code 46) and <code>&#39;1&#39;<\/code> (character code 49) come before <code>&#39;:&#39;<\/code>. This may or may not matter for your particular application, but there are better ways to approach namespacing.<\/p>\n\n<h4 id='recommended_delimiters'>Recommended delimiters<\/h4>\n\n<p>At the beginning of the printable ASCII character range is <code>&#39;!&#39;<\/code> (character code 33), and at the end we find <code>&#39;~&#39;<\/code> (character code 126). Using these characters as a delimiter we find the following sorting for our keys:<\/p>\n<div class='highlight'><pre><code class='text'>rod!...\nrod.vagg!...\nrod1977!...\nroderick!...\n<\/code><\/pre>\n<\/div>\n<p>or<\/p>\n<div class='highlight'><pre><code class='text'>rod.vagg~...\nrod1977~...\nroderick~...\nrod~...\n<\/code><\/pre>\n<\/div>\n<p>But why stick to the printable range? We can go right to the edges of the single-byte character range and use <code>&#39;\\x00&#39;<\/code> (<em>null<\/em>) or <code>&#39;\\xff&#39;<\/code> (<em>&#255;<\/em>).<\/p>\n\n<p>For best sorting of your entries, choose <code>&#39;\\x00&#39;<\/code> (or <code>&#39;!&#39;<\/code> if you really can&#8217;t stomach it). But whatever delimiter you choose, you&#8217;re still going to need to control the characters that can be used as keys. Allowing user-input to determine your keys and not stripping out your delimiter character could result in the NoSQL equivalent of an <em>SQL Injection Attack<\/em> (e.g. consider the unintended consequences that may arise with the dataset above with a delimiter of <code>&#39;!&#39;<\/code> and allowing a user to have that character in their username).<\/p>\n\n<h3 id='range_queries'>Range queries<\/h3>\n\n<p>LevelUP&#8217;s ReadStream is the perfect range query mechanism. By combining <code>&#39;start&#39;<\/code> and <code>&#39;end&#39;<\/code>, which just need to be approximations of actual keys, you can pluck out the exact the entries you want.<\/p>\n\n<p>Using our namespaced dataset above, with <code>&#39;\\x00&#39;<\/code> as delimiters, we can fetch all entries for just a single user by carafting a ReadStream range query:<\/p>\n<div class='highlight'><pre><code class='javascript'><span class='kd'>var<\/span> <span class='nx'>entries<\/span> <span class='o'>=<\/span> <span class='p'>[]<\/span>\n\n<span class='nx'>db<\/span><span class='p'>.<\/span><span class='nx'>createReadStream<\/span><span class='p'>({<\/span> <span class='nx'>start<\/span><span class='o'>:<\/span> <span class='s1'>&#39;rod\\x00&#39;<\/span><span class='p'>,<\/span> <span class='nx'>end<\/span><span class='o'>:<\/span> <span class='s1'>&#39;rod\\x00\\xff&#39;<\/span> <span class='p'>})<\/span>\n  <span class='p'>.<\/span><span class='nx'>on<\/span><span class='p'>(<\/span><span class='s1'>&#39;data&#39;<\/span><span class='p'>,<\/span> <span class='kd'>function<\/span> <span class='p'>(<\/span><span class='nx'>entry<\/span><span class='p'>)<\/span> <span class='p'>{<\/span> <span class='nx'>entries<\/span><span class='p'>.<\/span><span class='nx'>push<\/span><span class='p'>(<\/span><span class='nx'>entry<\/span><span class='p'>)<\/span> <span class='p'>})<\/span>\n  <span class='p'>.<\/span><span class='nx'>on<\/span><span class='p'>(<\/span><span class='s1'>&#39;close&#39;<\/span><span class='p'>,<\/span> <span class='kd'>function<\/span> <span class='p'>()<\/span> <span class='p'>{<\/span> <span class='nx'>console<\/span><span class='p'>.<\/span><span class='nx'>log<\/span><span class='p'>(<\/span><span class='nx'>entries<\/span><span class='p'>)<\/span> <span class='p'>})<\/span>\n<\/code><\/pre>\n<\/div>\n<p>Would give us:<\/p>\n<div class='highlight'><pre><code class='javascript'><span class='p'>[<\/span> <span class='p'>{<\/span> <span class='nx'>key<\/span><span class='o'>:<\/span> <span class='s1'>&#39;rod\\x00last_login&#39;<\/span><span class='p'>,<\/span> <span class='nx'>value<\/span><span class='o'>:<\/span> <span class='s1'>&#39;1367488445080&#39;<\/span> <span class='p'>},<\/span>\n  <span class='p'>{<\/span> <span class='nx'>key<\/span><span class='o'>:<\/span> <span class='s1'>&#39;rod\\x00default_theme&#39;<\/span><span class='p'>,<\/span> <span class='nx'>value<\/span><span class='o'>:<\/span> <span class='s1'>&#39;funky&#39;<\/span> <span class='p'>}<\/span> <span class='p'>]<\/span>\n<\/code><\/pre>\n<\/div>\n<p>The <code>&#39;\\xff&#39;<\/code> comes in handy here because we can use it to include every string of characters preceding it, so any of our user session keys will be included, as long as they don&#8217;t start with <code>&#39;\\xff&#39;<\/code>. So again, you need to control the allowable characters in your keys in order to avoid surprises.<\/p>\n\n<p>Namespacing and range queries are heavily used by many of the libraries that extend LevelUP. In the final article in this series we&#8217;ll be exploring some of the amazing ways that developers are extending LevelUP to provide additional features, applications and complete databases.<\/p>\n\n<p>If you want to jump ahead, visit the <strong><a href='https:\/\/github.com\/rvagg\/node-levelup\/wiki\/Modules'>Modules<\/a><\/strong> page on the LevelUP wiki.<\/p>\n"
      }
    };;

  beforeEach(inject(function (_articles_, $injector, $rootScope) {
    $httpBackend = $injector.get('$httpBackend');

    $httpBackend.whenJSONP("http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20xml%20where%20url%3D'"+
      "http%3A%2F%2Fdailyjs.com%2Fatom.xml"+
      "'%20and%20itemPath%3D'feed'&format=json&diagnostics=true&callback=JSON_CALLBACK")
      .respond({foo: 'bar'});

    $httpBackend.whenJSONP("http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20xml%20where%20url%3D'"+
        "http%3A%2F%2Ffeeds.mashable.com%2FMashable"+
        "'%20and%20itemPath%3D'feed'&format=json&diagnostics=true&callback=JSON_CALLBACK")
      .respond({foo: 'bar'});

    $httpBackend.whenJSONP("http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20xml%20where%20url%3D'"+
        "http%3A%2F%2Fangularjs.org%2Fsuperheroicfeed"+
        "'%20and%20itemPath%3D'feed'&format=json&diagnostics=true&callback=JSON_CALLBACK")
      .respond({error: 'feed does not exist'}, {status: 404});
    
    articles = _articles_;

    scope = $rootScope;
  }));

  it('should return a promise for loading a feed', function () {
    var responseData;

    articles.fetch('http%3A%2F%2Fdailyjs.com%2Fatom.xml', 'feed').then(function (res) {
      responseData = res.data;
    });

    $httpBackend.flush();
    scope.$digest();
    
    expect(responseData.foo).toBeDefined();
  });

  it('should change the query for different URLs passed in', function () {
    var responseData;

    articles.fetch(encodeURIComponent('http://feeds.mashable.com/Mashable'), 'feed').then(function (res) {
      responseData = res.data;
    });

    $httpBackend.flush();
    scope.$digest();

    expect(responseData.foo).toBeDefined();
  });

  it('should normalize articles from different feeds into a consumable format', function () {
    var normalizedAtom = articles.normalize(atomArticle, 'atom');
    expect(Object.keys(normalizedAtom).sort()).toEqual(['content', 'contentType', 'id', 'link', 'title', 'updated'])
  });

  it('should make a truncated plaintext preview of the content', function () {
    var normalizedAtom = articles.normalize(atomArticle, 'atom');
    expect(!!normalizedAtom.preview).toBe(true);
    expect(normalizedAtom.preview).not.toContain('<img');
    expect(normalizedAtom.preview.split(' ').length).toBeLessThan(50);
  })

  it('should normalize an item as atom if no inputFormat is provided', function () {
    var normalizedAtom = articles.normalize(atomArticle);
    expect(Object.keys(normalizedAtom).sort()).toEqual(['content', 'contentType', 'id', 'link', 'title', 'updated'])
  })
});